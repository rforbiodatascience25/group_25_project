---
title: "05_analysis_1"
format:
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
library("tidyverse")
library("dplyr")
library("here")
```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
#| message: false
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

-   **data_metrics** — patient demographics (age, sex, race, ancestry)
-   **data_gene** — genomic instability metrics (mutation count, TMB, fraction genome altered).
-   **data_score** — biological scores (aneuploidy, hypoxia, MSI).
-   **data_code** — cancer staging and clinical classification codes.
-   **data_diag** — diagnoses, survival outcomes, therapy history.

## Plotting

### Genomic Alterations & Instability (data_gene) 

```{r}
data_metrics |> 
  select(-c(`Genetic Ancestry Label`, `Race Category`, `Ethnicity Category`))

data_metrics_gene <- full_join( data_metrics, data_gene, by="Patient ID")
```

------------------------------------------------------------------------

```{r}
data_metrics_gene |>
  filter(`Mutation Count` < 5000) # take out outlier
```

```{r}
data_gene_code = full_join(data_gene, data_code, by = "Patient ID")
```

```{r}
data_gene_code |>
  filter(`Mutation Count` < 5000) |> 
  pivot_longer(cols = c(`Fraction Genome Altered`, 
                        `Mutation Count`, 
                        `TMB (nonsynonymous)`, 
                        `Tumor Break Load`),
               names_to = "Genomic_Metric", 
               values_to = "Value") |> 
ggplot(mapping = 
         aes(x = `Neoplasm Disease Stage American Joint Committee on Cancer Code`, 
             y = Value)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ Genomic_Metric, scales = "free_y")
```

Heatmap of hypoxia and MSI scores across patients or groups: Highlights patterns and clusters associated with tumor microenvironment, useful for exploratory group identification.

```{r}
metric_for_order <- "Buffa Hypoxia Score"

df_long <- data_score |>
  select(`Patient ID`,
         `Buffa Hypoxia Score`,
         `Ragnum Hypoxia Score`,
         `Winter Hypoxia Score`) |>
  drop_na() |>
  pivot_longer(
    cols = -`Patient ID`,
    names_to = "Metric",
    values_to = "Score"
  ) |>
  group_by(`Patient ID`) |>
  mutate(
    order_value = Score[Metric == metric_for_order][1]
  ) |>
  ungroup() |>
  mutate(
    `Patient ID` = fct_reorder(`Patient ID`, order_value, .desc = TRUE)
  )

ggplot(df_long,
       aes(x = `Patient ID`, y = Metric, fill = Score)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  labs(
    title = "Hypoxia and MSI scores across patients",
    x = "Patient", y = "Metric", fill = "Score"
  )

```

```{r}
metric_for_order <- "Winter Hypoxia Score"

df_long <- data_score |>
  select(`Patient ID`,
         `MSI MANTIS Score`,
         `MSIsensor Score`,
         `Buffa Hypoxia Score`,
         `Ragnum Hypoxia Score`,
         `Winter Hypoxia Score`) |>
  drop_na() |>
  pivot_longer(
    cols = -`Patient ID`,
    names_to = "Metric",
    values_to = "Score"
  ) |>
  group_by(Metric) |>
  mutate(
    Score_scaled = (Score - mean(Score, na.rm = TRUE)) /
                   sd(Score, na.rm = TRUE)
  ) |>
  ungroup() |>
  group_by(`Patient ID`) |>
  mutate(
    order_value = Score_scaled[Metric == metric_for_order][1]
  ) |>
  ungroup() |>
  mutate(
    `Patient ID` = fct_reorder(`Patient ID`, order_value, .desc = TRUE)
  )

ggplot(df_long,
       aes(x = `Patient ID`, y = Metric, fill = Score_scaled)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  labs(
    title = "MSI scores across patients (z-scaled)",
    x = "Patient", y = "Metric", fill = "z-score"
  )

```
