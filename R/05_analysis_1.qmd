---
title: "05_analysis_1"
format:
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
#| message: false
library("tidyverse")
library("here")
```

## Visual Guidelines

```{r}
theme_uniform <- function(base_size = 14, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      plot.title    = element_text(face = "bold", size = base_size + 2, hjust = 0),
      axis.title    = element_text(face = "bold"),
      axis.text     = element_text(color = "gray20"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(color = "gray90", size = 0.3),
      strip.text    = element_text(face = "bold"),
      strip.background = element_rect(fill = "gray95", color = NA),
      legend.position = "right",
      legend.title = element_text(face = "bold"),
      plot.margin = margin(10, 10, 10, 10)
    )
}

#colorblind-safe color PALETTE
#pick values for color and fill
palette <- c(
  "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7"
)

#colorblind-safe color GRADIENTS
scale_fill_uniform_continuous  <- scale_fill_gradientn(
  colors = c("#2166AC", "#F7F7F7", "#B2182B")
)
scale_color_uniform_continuous <- scale_color_gradientn(
  colors = c("#2166AC", "#F7F7F7", "#B2182B")
)

#geometry defaults
update_geom_defaults("line",   list(linewidth = 1))
update_geom_defaults("point",  list(size = 2, stroke = 0.5))
update_geom_defaults("boxplot", list(linewidth = 0.6))
update_geom_defaults("violin",  list(linewidth = 0.6))

#presentation settings
presentation_fig_width  <- 7
presentation_fig_height <- 4.5
presentation_dpi        <- 200

#aspect ratios
aspect_wide    <- c(width = 7,  height = 4)   #wide (16:9) for time series / line plots:
aspect_square  <- c(width = 5,  height = 5)   #square (1:1) for correlations & scatter:
aspect_tall    <- c(width = 5,  height = 7)   #tall (3:4) for barplots with long labels:

#annotation settings high contrast
annotation_text <- list(color = "black", size = 5, fontface = "bold")

#remove excess padding
scale_y_continuous_uniform <- scale_y_continuous(expand = expansion(mult = c(0, 0.05)))
scale_x_continuous_uniform <- scale_x_continuous(expand = expansion(mult = c(0.02, 0.02)))
```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
#| message: false
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

-   **data_metrics** — patient demographics (age, sex, race, ancestry)
-   **data_gene** — genomic instability metrics (mutation count, TMB, fraction genome altered).
-   **data_score** — biological scores (aneuploidy, hypoxia, MSI).
-   **data_code** — cancer staging and clinical classification codes.
-   **data_diag** — diagnoses, survival outcomes, therapy history.

------------------------------------------------------------------------

## PCA

We performed PCA to reduce the dimensionality of our clinical and genomic variables and to explore major patterns of variation across patients. We first selected the continuous variables of interest from the merged dataset, then centered and scaled them so they were on comparable scales, and finally ran PCA with `prcomp()` to obtain principal components for visualization and downstream analyses.

```{r}
data_all <- data_metrics |>
  left_join(data_gene,  by = "Patient ID") |>
  left_join(data_score, by = "Patient ID") |>
  left_join(data_code,  by = "Patient ID") |>
  left_join(data_diag,  by = "Patient ID")
```

The correlation matrix of diagnostic endpoints revealed very strong positive correlations among the different survival time measures and their corresponding status variables, indicating that these outcomes largely capture the same underlying prognosis information. This redundancy was especially clear for variable pairs measuring the same outcome in different units (days vs. months), which showed extremely high correlations, confirming that they encode equivalent survival information. Overall, only modest variation in correlation strength was observed across endpoints, highlighting high redundancy between disease-free, progression-free, and overall survival metrics.

```{r}
#| fig-height: 6
correl_matrix <- data_diag |>
  select(where(is.numeric)) |> 
  cor(use = "complete.obs")

corrplot(correl_matrix, method = "color", tl.col = "black")
```

We used the correlation matrix to identify highly redundant diagnostic variables, particularly pairs that measured the same survival outcome in different time units (days vs. months). Based on this, we selected a subset of endpoints that did not show strong mutual correlations to avoid duplication and to keep only non-redundant variables for subsequent analyses.

```{r}
pca_data <- data_all |>
  select(
    where(is.numeric),
    -c(`Overall Survival (Months)`,
       `Disease Free (Months)`,
       `Months of disease-specific survival`,
       `Progress Free Survival (Months)`,
       `Disease Free Status (bin)`,
       `Disease Free (days)`, # loads of NA because some die
       `Days of disease-specific survival`,
       `Progress Free Survival (days)`
    ) 
  )  |> 
  drop_na()
```

```{r}
data_pca <- pca_data |>
  drop_na()
```

```{r}
pca_fit <- data_pca |> 
  select(-`Disease-specific Survival status (bin)`) |> 
  scale() |> 
  prcomp()
```

We ran a principal component analysis on the selected standardized diagnostic variables (excluding the overall survival status indicator) to summarize variation in a low-dimensional space. The first two principal components were then plotted, and the points were colored by Overall Survival Status (bin) to visually assess whether the main axes of variation separated patients with different survival outcomes.

```{r}
#| fig-height: 6
#| fig-width: 9
pca_fit |>
  augment(data_pca) |>
  ggplot(aes(x = .fittedPC1,
             y = .fittedPC2,
             color = factor(`Disease-specific Survival status (bin)`))) +
  geom_point(size = 1.5) +
  scale_color_discrete(
    name   = "Disease-specific Survival status",
    labels = c("ALIVE OR DEAD TUMOR FREE", "DEAD WITH TUMOR")  # 0 -> "Alive", 1 -> "Dead"
  ) +
  labs(
    title = "PCA of diagnostic variables",
    x = "Principal Component 1",
    y = "Principal Component 2"
  ) +
  theme_uniform() +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal"
  )
```

In the PCA plot of the first two components, patients who were dead with tumor and those who were alive or dead tumor‑free occupy partially distinct regions of the PC1–PC2 space, suggesting some degree of separation between the two groups. However, there is substantial overlap between clusters, indicating that the main axes of variation in the selected diagnostic variables only moderately discriminate disease specific survival status.

```{r}
#| fig-height: 7
pca_fit |> 
  tidy(matrix = "eigenvalues") |> 
  ggplot(aes(PC, cumulative)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  geom_hline(yintercept = 0.8,
             linetype = "dashed",
             color = "grey30",
             linewidth = 0.6) +
  scale_x_continuous(breaks = 1:14) +
  scale_y_continuous(
  breaks = c(0, 0.25, 0.5, 0.75, 0.8, 1),
  labels = scales::percent_format(),
  expand = expansion(mult = c(0, 0.01))
) +
  theme_uniform() +
  labs(
  x = "Principal component",
  y = "Cumulative variance across PCs",
  title = "Cumulative explained variance by principal component"
)
```

The cumulative variance plot shows that the first few principal components already explain most of the variability in the diagnostic variables. In our data, the first PC accounts for about one third of the variance, and the first 7-8 PCs together exceed the commonly used 80–90% threshold, indicating that a relatively low-dimensional representation captures the majority of information in the original feature set.

```{r}
rotation_matrix <- pca_fit |> 
  tidy(matrix = "rotation")
```

```{r}
#| fig-height: 7

number_of_PC = 4
minimum_value_for_coef = 0.2

rotation_matrix |>
  filter(
    PC %in% c(1:number_of_PC),
    abs(value) > minimum_value_for_coef
  ) |>
  ggplot(aes(x = PC,
             y = value,
             fill = column)) +
  geom_col(position = "dodge") +
  geom_vline(
    xintercept = seq(1.5, length(c(1:number_of_PC)) + 0.5, by = 1),
    linetype = "dashed"
  ) +
  labs(
    title = "Loadings of selected variables on principal components",
    x = "Principal Component",
    y = "Loading coefficient",
    fill = "Variable"
  ) +
  theme_uniform()
```

The loading plot for the first four principal components shows which diagnostic and biological variables contribute most strongly to each PC. PC1 is mainly driven by hypoxia scores and genomic instability metrics, whereas PC2 and PC3 capture additional variation related to survival endpoints and mutation/TMB measures, with opposite signs indicating variables that vary in contrasting directions. Overall, the pattern of loadings suggests that the main PCs summarize combined effects of hypoxia, genomic instability, and survival outcomes rather than being dominated by a single variable.

The PCA of the selected diagnostic and molecular variables provided a compact, low‑dimensional representation that explained most of the variance with only a handful of components. The PCA loadings highlighted clusters of variables with similar contributions to the same components, consistent with the strong correlations observed among several variables, and reinforcing that part of the information in the feature set is redundant.
