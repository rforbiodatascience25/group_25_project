---
title: "04_describe"
format: 
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
library("tidyverse")
library("here")
```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

## Metrics summary

List the metrics, the number of metrics, the types within the metrics, and the median values within each types.

```{r}
str(data_metrics)

sort_data <- function(data_category) {
  sorted__table <- sort(table(data_category), decreasing = TRUE)
  paste(paste0(names(sorted__table), " (", sorted__table, ")"), collapse = ", ")
}

metrics_list <- list(
  "Diagnosis Age"            = data_metrics$`Diagnosis Age`,
  "Sex"                      = data_metrics$`Sex`,
  "Genetic Ancestry Label"   = data_metrics$`Genetic Ancestry Label`,
  "Race Category"            = data_metrics$`Race Category`,
  "Ethnicity Category"       = data_metrics$`Ethnicity Category`
)

sorted_list <- lapply(metrics_list, sort_data)

n_distinct_list <- sapply(metrics_list, function(metric) length(unique(na.omit(metric))))

metrics_summary <- data.frame(
  n_distinct = as.numeric(n_distinct_list),
  Types    = unlist(sorted_list),
  stringsAsFactors = FALSE
)

n_patients     <- length(data_metrics$`Patient ID`)
n_distinct_patients  <- length(unique(na.omit(data_metrics$`Patient ID`)))

patient_row <- data.frame(
  Columns  = "Patient ID",
  n_distinct = n_distinct_patients,
  Types    = paste0("Total entries: ", n_patients),
  stringsAsFactors = FALSE
)

patient_row
metrics_summary
```

## **Gene summary**

Providing core statistics overview of the genetic mutation data with a basic descriptive stats table and histograms and box plots. Outliers are removed to avoid making the graphs unreadable.

```{r}
str(data_gene)

genes <- list(
  "Fraction Genome Altered" = data_gene$`Fraction Genome Altered`,
  "Mutation Count"          = data_gene$`Mutation Count`,
  "TMB (nonsynonymous)"     = data_gene$`TMB (nonsynonymous)`,
  "Tumor Break Load"        = data_gene$`Tumor Break Load`
)

remove_extreme <- function(gene) gene[gene != max(gene, na.rm = TRUE)]

genes_no_ext <- lapply(genes, remove_extreme)

plot_gene <- function(genes_no_ext, title) {
  
  hist(genes_no_ext, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(genes_no_ext, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(genes_no_ext)) plot_gene(genes_no_ext[[n]], n)

gene_summary <- data.frame(
  
  Categories = names(genes_no_ext),
  
  Means   = sapply(genes_no_ext, function(genes_no_ext) format(round(mean(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(genes_no_ext, function(genes_no_ext) format(round(median(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(genes_no_ext, function(genes_no_ext) format(round(sd(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

gene_summary
```

## Score Summary

Providing core statistics overview of the cancer scoring data with a basic descriptive stats table and histograms and box plots. Outliers not removed/present.

```{r}
str(data_score)

scores_list <- list(
  "Aneuploidy Score"     = data_score$`Aneuploidy Score`,
  "Buffa Hypoxia Score"  = data_score$`Buffa Hypoxia Score`,
  "MSI MANTIS Score"     = data_score$`MSI MANTIS Score`,
  "MSIsensor Score"      = data_score$`MSIsensor Score`,
  "Ragnum Hypoxia Score" = data_score$`Ragnum Hypoxia Score`,
  "Winter Hypoxia Score" = data_score$`Winter Hypoxia Score`
)

plot_score <- function(scores_list, title) {
  
  hist(scores_list, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(scores_list, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(scores_list)) plot_score(scores_list[[n]], n)

score_summary <- data.frame(
  
  Means = sapply(scores_list, function(scores_list) format(round(mean(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(scores_list, function(scores_list) format(round(median(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(scores_list, function(scores_list) format(round(sd(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

score_summary
```

## Codes Summary

Summary of the various types of cancer codes.

```{r}
str(data_code)

make_types <- function(dataset_category) {
  sorted_table <- sort(table(dataset_category), decreasing = TRUE)
  paste(paste0(names(sorted_table), " (", sorted_table, ")"), collapse = ", ")
}

neoplasm_stage_types <- make_types(data_code$`Neoplasm Disease Stage American Joint Committee on Cancer Code`)
icd_histology_types  <- make_types(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Histology Code`)
icd_site_types       <- make_types(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Site Code`)
joint_stage_types    <- make_types(data_code$`American Joint Committee on Cancer Metastasis Stage Code`)
lymph_stage_types    <- make_types(data_code$`Neoplasm Disease Lymph Node Stage American Joint Committee on Cancer Code`)
tumor_stage_types    <- make_types(data_code$`American Joint Committee on Cancer Tumor Stage Code`)

neoplasm_stage_distinct <- length(unique(na.omit(data_code$`Neoplasm Disease Stage American Joint Committee on Cancer Code`)))
icd_histology_distinct  <- length(unique(na.omit(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Histology Code`)))
icd_site_distinct       <- length(unique(na.omit(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Site Code`)))
joint_stage_distinct    <- length(unique(na.omit(data_code$`American Joint Committee on Cancer Metastasis Stage Code`)))
lymph_stage_distinct    <- length(unique(na.omit(data_code$`Neoplasm Disease Lymph Node Stage American Joint Committee on Cancer Code`)))
tumor_stage_distinct    <- length(unique(na.omit(data_code$`American Joint Committee on Cancer Tumor Stage Code`)))

code_summary <- data.frame(
  Columns = c(
    "Neoplasm Disease Stage Code",
    "ICD-O-3 Histology Code",
    "ICD-O-3 Site Code",
    "AJCC Metastasis Stage Code",
    "AJCC Lymph Node Stage Code",
    "AJCC Tumor Stage Code"
  ),
  
  Distinct = c(
    neoplasm_stage_distinct,
    icd_histology_distinct,
    icd_site_distinct,
    joint_stage_distinct,
    lymph_stage_distinct,
    tumor_stage_distinct
  ),
  
  Types = c(
    neoplasm_stage_types,
    icd_histology_types,
    icd_site_types,
    joint_stage_types,
    lymph_stage_types,
    tumor_stage_types
  ),
  
  stringsAsFactors = FALSE
)

code_summary
```

## Diagnoses Summary

Summary of the different cancer diagnoses.

```{r}
str(data_diag)

#--------------
#numerical data
#--------------
diagnosis_list_numeric <- list(
  "Overall Survival (days)"        = data_diag$`Overall Survival (days)`,
  "Overall Survival (months)"      = data_diag$`Overall Survival (Months)`,

  "Disease Free (months)"          = data_diag$`Disease Free (Months)`,
  "Disease Free (days)"            = data_diag$`Disease Free (days)`,

  "Progression Free (months)"      = data_diag$`Progress Free Survival (Months)`,
  "Progression Free (days)"        = data_diag$`Progress Free Survival (days)`
)

plot_diagnosis <- function(diagnosis, title) {
  
  hist(diagnosis, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(diagnosis, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(diagnosis_list_numeric)) plot_diagnosis(diagnosis_list_numeric[[n]], n)

diagnosis_numerical_summary <- data.frame(
  
  Means   = sapply(diagnosis_list_numeric, function(diagnosis) format(round(mean(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(diagnosis_list_numeric, function(diagnosis) format(round(median(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(diagnosis_list_numeric, function(diagnosis) format(round(sd(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

diagnosis_numerical_summary
#---------------



#----------------
#categorical data
#----------------
sort_data <- function(data_category) {
  sorted__table <- sort(table(data_category), decreasing = TRUE)
  paste(paste0(names(sorted__table), " (", sorted__table, ")"), collapse = ", ")
}

diagnosis_list_categorical <- list(
  "Tumor Type"                             = data_diag$`Tumor Type`,
  "Overall Survival Status (bin)"          = data_diag$`Overall Survival Status (bin)`,
  "Overall Survival Status (des)"          = data_diag$`Overall Survival Status (des)`,
  "Disease-specific Survival Status (des)" = data_diag$`Disease-specific Survival status (des)`,
  "Disease Free Status (bin)"              = data_diag$`Disease Free Status (bin)`,
  "Disease Free Status (des)"              = data_diag$`Disease Free Status (des)`,
  "Progression Free Status (bin)"          = data_diag$`Progression Free Status (bin)`,
  "Progression Free Status (des)"          = data_diag$`Progression Free Status (des)`,
  "Prior Diagnosis"                        = data_diag$`Prior Diagnosis`,
  "Radiation Therapy"                      = data_diag$`Radiation Therapy`,
  "Primary Lymph Node Assessment"          = data_diag$`Primary Lymph Node Presentation Assessment`,
  "Person Neoplasm Status"                 = data_diag$`Person Neoplasm Cancer Status`,
  "New Neoplasm Event"                     = data_diag$`New Neoplasm Event Post Initial Therapy Indicator`,
  "Histologic Grade"                       = data_diag$`Neoplasm Histologic Grade`,
  "ICD-10 Classification"                  = data_diag$`ICD-10 Classification`
)

sorted_list <- lapply(diagnosis_list_categorical, sort_data)

n_distinct_list <- sapply(diagnosis_list_categorical, function(diagnosis) length(unique(na.omit(diagnosis))))

diagnosis_categorical_summary <- data.frame(
  n_distinct = as.numeric(n_distinct_list),
  Types    = unlist(sorted_list),
  stringsAsFactors = FALSE
)

diagnosis_categorical_summary
#---------------
```

## Comparative Analysis of Variables Within a Common Theme

In our dataset (divided ones), multiple variables often classify similar attributes or quantify related parameters, so it is essential to analyze the correlations between these variables to uncover their relationships and potential interdependencies.

Furthermore, some variables may not be meaningful for analysis. For example, nominal variables that overwhelmingly dominate the dataset, where one category accounts for the vast majority of observations, may offer limited insight and can be excluded from detailed examination.

### Data metrics (data_metrics)

#### Age distribution

Males exhibit a slightly higher mean age at diagnosis compared to females.

```{r}
counts <- data_metrics |> 
  group_by(Sex) |> 
  summarise(n = n())

lab_female <- paste0("Women (n = ", counts$n[counts$Sex == "Female"], ")")
lab_male   <- paste0("Men (n = ", counts$n[counts$Sex == "Male"], ")")

data_metrics |>
  ggplot(aes(x = `Diagnosis Age`, fill = Sex)) +
  geom_density(alpha = 0.5) +
  scale_fill_discrete(
    name   = "Sex",
    labels = c("Female" = lab_female,
               "Male"   = lab_male)
  )
```

Age groups of \[30,40\] and \[80,90\] contain too few individuals to support reliable statistical analysis.​

```{r}
data_metrics |> 
  ggplot(mapping = 
           aes( x = Sex,
                fill = Age_Group)) +
  geom_bar(position = "dodge", color = "black", alpha = 0.5) +
  theme_minimal()
```

#### Race, Genetic Ancestry Label, and Ethnicity Category

Race, Genetic Ancestry Label, and Ethnicity Category strongly overlap in our data, with most individuals of European ancestry also classified as White and similar by ethnicity. This high correlation limits diversity across subgroups, rendering analyses stratified by these categories unreliable for drawing meaningful conclusions.

```{r}
data_metrics |> 
  ggplot(mapping = 
           aes(x = `Race Category`,
               fill = `Ethnicity Category`)) + # can change to Genetic Ancestry Label
  geom_bar(position = position_dodge(preserve = "single"), color = "black", alpha = 0.7) +
  geom_vline(xintercept = seq(0.5, length(unique(data_metrics$`Race Category`)) + 0.5, by = 1), linetype = "dashed") +
  theme_minimal()
```

This was kinda proven by the tables above, but we build on it to show off correlation.

### Genomic Alterations & Instability (data_gene) 

Fraction Genome Altered - The proportion of the tumor’s genome with copy number gains or losses, reflecting the extent of chromosomal instability present in the cancer cells.

Mutation Count - The total number of mutations identified in the tumor genome, typically including single-nucleotide variants and small insertions/deletions.

TMB (nonsynonymous) - Tumor Mutation Burden (TMB) is the number of nonsynonymous mutations (those that change protein sequences) per megabase of DNA in the tumor, and is used to estimate overall mutational load.

Tumor Break Load - The quantity or extent of structural variants in the tumor genome, representing breaks or major rearrangements, which indicate higher genomic instability in the tumor.

```{r}
library(corrplot)
cor_matrix <- cor(data_gene |>
                    select(`Fraction Genome Altered`, 
                           `Mutation Count`, 
                           `TMB (nonsynonymous)`, 
                           `Tumor Break Load`), 
                    use = "complete.obs")

corrplot(cor_matrix, method = "color")
```

We excluded one extreme outlier before plotting; the resulting positive correlation is consistent with random mutagenesis, where the proportion of nonsynonymous mutations remains relatively stable given a fixed coding sequence fraction.

### Cancer Classification Systems (data_code)

```{r}
ClassificationSystems <- c(
  "Neoplasm Disease Stage American Joint Committee on Cancer Code",
  "International Classification of Diseases for Oncology, Third Edition ICD-O-3 Histology Code",
  "International Classification of Diseases for Oncology, Third Edition ICD-O-3 Site Code",
  "American Joint Committee on Cancer Metastasis Stage Code",
  "Neoplasm Disease Lymph Node Stage American Joint Committee on Cancer Code",
  "American Joint Committee on Cancer Tumor Stage Code"
)
```

```{r}
class_sym_1 <- ClassificationSystems[1]  
class_sym_2 <- ClassificationSystems[3]

data_code |>
  count(!!sym(class_sym_1),
        !!sym(class_sym_2)) |>
  ggplot(aes(x = !!sym(class_sym_1),
             y = !!sym(class_sym_2),
             fill = n)) +
  geom_tile() +
  geom_text(aes(label = n), color = "white", size = 3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Count")
```

It is also inherently difficult to evaluate “coherence” between these systems quantitatively, because they use different numbers of categories and different underlying metrics.

American Joint Committee on Cancer Metastasis Stage Code (MX) -\> Metastasis cannot be assessed or information is insufficient to assign an M category

Besides this always one class that has the greatest

```{r}
entropy_cat <- function(x) {
  p <- prop.table(table(x))
  -sum(p * log(p))
}
```

```{r}
vars_to_check <- c(
  ClassificationSystems[1], # Neoplasm disease stage
  ClassificationSystems[2], 
  ClassificationSystems[3],
  ClassificationSystems[4], # AJCC metastasis stage code
  ClassificationSystems[5], # Lymph node stage
  ClassificationSystems[6]  # Tumor stage
)

dispersion_tbl <-
  tibble(var_name = vars_to_check) |>
  mutate(
    entropy = map_dbl(var_name, ~ {
      x <- data_code[[.x]]
      x <- x[!is.na(x)]         # remove NAs for this variable
      entropy_cat(x)
    }),
    n_levels = map_int(var_name, ~ {
      x <- data_code[[.x]]
      n_distinct(x, na.rm = TRUE)
    })
  ) |>
  arrange(desc(entropy))

dispersion_tbl
```

The Neoplasm Disease Stage American Joint Committee on Cancer Code shows the highest entropy among the examined systems.

### Biological scores (aneuploidy, hypoxia, MSI) (**data_score)**

```{r}
data_score
```

```{r}
# Select only score columns
score_cols <- c(
  "Aneuploidy Score", 
  "Buffa Hypoxia Score",
  "MSI MANTIS Score", 
  "MSIsensor Score",
  "Ragnum Hypoxia Score", 
  "Winter Hypoxia Score"
)

correl_matrix <- data_score |>
  select(all_of(score_cols)) |>
  cor(use = "complete.obs")

corrplot(correl_matrix, 
         method = "color", 
         tl.col = "black")
```

-   Aneuploidy Score → chromosome-level copy-number changes.

-   MSI MANTIS / MSIsensor → microsatellite instability (DNA repair).

-   Buffa / Ragnum / Winter → hypoxia from expression, different gene signatures.

```{r}
data_score |> 
  ggplot(mapping = 
           aes( x = `Tissue Source Site Code`)) +
  geom_bar() +
  theme_minimal()
```

### Tumor Types distribution (**data_diag)**

```{r}
#| fig-height: 5

data_diag |>
  ggplot(aes(x = `Tumor Type`, 
             fill = `Tumor Type`)) +
  geom_bar() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank()
  )
```

Not enough disersity in tumor types.
