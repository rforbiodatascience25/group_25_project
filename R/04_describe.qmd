---
title: "04_describe"
format: 
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
library("tidyverse")
library("here")
```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

## Metrics summary

List the metrics, the number of metrics, the types within the metrics, and the median values within each types.

```{r}
str(data_metrics)

sort_data <- function(data_category) {
  sorted__table <- sort(table(data_category), decreasing = TRUE)
  paste(paste0(names(sorted__table), " (", sorted__table, ")"), collapse = ", ")
}

metrics_list <- list(
  "Diagnosis Age"            = data_metrics$`Diagnosis Age`,
  "Sex"                      = data_metrics$`Sex`,
  "Genetic Ancestry Label"   = data_metrics$`Genetic Ancestry Label`,
  "Race Category"            = data_metrics$`Race Category`,
  "Ethnicity Category"       = data_metrics$`Ethnicity Category`
)

sorted_list <- lapply(metrics_list, sort_data)

n_distinct_list <- sapply(metrics_list, function(metric) length(unique(na.omit(metric))))

metrics_summary <- data.frame(
  n_distinct = as.numeric(n_distinct_list),
  Types    = unlist(sorted_list),
  stringsAsFactors = FALSE
)

n_patients     <- length(data_metrics$`Patient ID`)
n_distinct_patients  <- length(unique(na.omit(data_metrics$`Patient ID`)))

patient_row <- data.frame(
  Columns  = "Patient ID",
  n_distinct = n_distinct_patients,
  Types    = paste0("Total entries: ", n_patients),
  stringsAsFactors = FALSE
)

patient_row
metrics_summary
```

## **Gene summary**

Providing core statistics overview of the genetic mutation data with a basic descriptive stats table and histograms and box plots. Outliers are removed to avoid making the graphs unreadable.

```{r}
str(data_gene)

genes <- list(
  "Fraction Genome Altered" = data_gene$`Fraction Genome Altered`,
  "Mutation Count"          = data_gene$`Mutation Count`,
  "TMB (nonsynonymous)"     = data_gene$`TMB (nonsynonymous)`,
  "Tumor Break Load"        = data_gene$`Tumor Break Load`
)

remove_extreme <- function(gene) gene[gene != max(gene, na.rm = TRUE)]

genes_no_ext <- lapply(genes, remove_extreme)

plot_gene <- function(genes_no_ext, title) {
  
  hist(genes_no_ext, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(genes_no_ext, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(genes_no_ext)) plot_gene(genes_no_ext[[n]], n)

gene_summary <- data.frame(
  
  Categories = names(genes_no_ext),
  
  Means   = sapply(genes_no_ext, function(genes_no_ext) format(round(mean(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(genes_no_ext, function(genes_no_ext) format(round(median(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(genes_no_ext, function(genes_no_ext) format(round(sd(genes_no_ext, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

gene_summary
```

## Score Summary

Providing core statistics overview of the cancer scoring data with a basic descriptive stats table and histograms and box plots. Outliers not removed/present.

```{r}
str(data_score)

scores_list <- list(
  "Aneuploidy Score"     = data_score$`Aneuploidy Score`,
  "Buffa Hypoxia Score"  = data_score$`Buffa Hypoxia Score`,
  "MSI MANTIS Score"     = data_score$`MSI MANTIS Score`,
  "MSIsensor Score"      = data_score$`MSIsensor Score`,
  "Ragnum Hypoxia Score" = data_score$`Ragnum Hypoxia Score`,
  "Winter Hypoxia Score" = data_score$`Winter Hypoxia Score`
)

plot_score <- function(scores_list, title) {
  
  hist(scores_list, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(scores_list, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(scores_list)) plot_score(scores_list[[n]], n)

score_summary <- data.frame(
  
  Means = sapply(scores_list, function(scores_list) format(round(mean(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(scores_list, function(scores_list) format(round(median(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(scores_list, function(scores_list) format(round(sd(scores_list, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

score_summary
```

## Codes Summary

Summary of the various types of cancer codes.

```{r}
str(data_code)

make_types <- function(dataset_category) {
  sorted_table <- sort(table(dataset_category), decreasing = TRUE)
  paste(paste0(names(sorted_table), " (", sorted_table, ")"), collapse = ", ")
}

neoplasm_stage_types <- make_types(data_code$`Neoplasm Disease Stage American Joint Committee on Cancer Code`)
icd_histology_types  <- make_types(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Histology Code`)
icd_site_types       <- make_types(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Site Code`)
joint_stage_types    <- make_types(data_code$`American Joint Committee on Cancer Metastasis Stage Code`)
lymph_stage_types    <- make_types(data_code$`Neoplasm Disease Lymph Node Stage American Joint Committee on Cancer Code`)
tumor_stage_types    <- make_types(data_code$`American Joint Committee on Cancer Tumor Stage Code`)

neoplasm_stage_distinct <- length(unique(na.omit(data_code$`Neoplasm Disease Stage American Joint Committee on Cancer Code`)))
icd_histology_distinct  <- length(unique(na.omit(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Histology Code`)))
icd_site_distinct       <- length(unique(na.omit(data_code$`International Classification of Diseases for Oncology, Third Edition ICD-O-3 Site Code`)))
joint_stage_distinct    <- length(unique(na.omit(data_code$`American Joint Committee on Cancer Metastasis Stage Code`)))
lymph_stage_distinct    <- length(unique(na.omit(data_code$`Neoplasm Disease Lymph Node Stage American Joint Committee on Cancer Code`)))
tumor_stage_distinct    <- length(unique(na.omit(data_code$`American Joint Committee on Cancer Tumor Stage Code`)))

code_summary <- data.frame(
  Columns = c(
    "Neoplasm Disease Stage Code",
    "ICD-O-3 Histology Code",
    "ICD-O-3 Site Code",
    "AJCC Metastasis Stage Code",
    "AJCC Lymph Node Stage Code",
    "AJCC Tumor Stage Code"
  ),
  
  Distinct = c(
    neoplasm_stage_distinct,
    icd_histology_distinct,
    icd_site_distinct,
    joint_stage_distinct,
    lymph_stage_distinct,
    tumor_stage_distinct
  ),
  
  Types = c(
    neoplasm_stage_types,
    icd_histology_types,
    icd_site_types,
    joint_stage_types,
    lymph_stage_types,
    tumor_stage_types
  ),
  
  stringsAsFactors = FALSE
)

code_summary
```

## Diagnoses Summary

Summary of the different cancer diagnoses.

```{r}
str(data_diag)

#--------------
#numerical data
#--------------
diagnosis_list_numeric <- list(
  "Overall Survival (days)"        = data_diag$`Overall Survival (days)`,
  "Overall Survival (months)"      = data_diag$`Overall Survival (Months)`,

  "Disease Free (months)"          = data_diag$`Disease Free (Months)`,
  "Disease Free (days)"            = data_diag$`Disease Free (days)`,

  "Progression Free (months)"      = data_diag$`Progress Free Survival (Months)`,
  "Progression Free (days)"        = data_diag$`Progress Free Survival (days)`
)

plot_diagnosis <- function(diagnosis, title) {
  
  hist(diagnosis, breaks = 30, main = paste("Distribution of", title), xlab = title, ylab = "Frequency")
  
  boxplot(diagnosis, main = paste("Boxplot of", title), ylab = title)
}

for (n in names(diagnosis_list_numeric)) plot_diagnosis(diagnosis_list_numeric[[n]], n)

diagnosis_numerical_summary <- data.frame(
  
  Means   = sapply(diagnosis_list_numeric, function(diagnosis) format(round(mean(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  Medians = sapply(diagnosis_list_numeric, function(diagnosis) format(round(median(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  Standard_Devations = sapply(diagnosis_list_numeric, function(diagnosis) format(round(sd(diagnosis, na.rm = TRUE), 2), trim = TRUE)),
  
  stringsAsFactors = FALSE
)

diagnosis_numerical_summary
#---------------



#----------------
#categorical data
#----------------
sort_data <- function(data_category) {
  sorted__table <- sort(table(data_category), decreasing = TRUE)
  paste(paste0(names(sorted__table), " (", sorted__table, ")"), collapse = ", ")
}

diagnosis_list_categorical <- list(
  "Tumor Type"                             = data_diag$`Tumor Type`,
  "Overall Survival Status (bin)"          = data_diag$`Overall Survival Status (bin)`,
  "Overall Survival Status (des)"          = data_diag$`Overall Survival Status (des)`,
  "Disease-specific Survival Status (des)" = data_diag$`Disease-specific Survival status (des)`,
  "Disease Free Status (bin)"              = data_diag$`Disease Free Status (bin)`,
  "Disease Free Status (des)"              = data_diag$`Disease Free Status (des)`,
  "Progression Free Status (bin)"          = data_diag$`Progression Free Status (bin)`,
  "Progression Free Status (des)"          = data_diag$`Progression Free Status (des)`,
  "Prior Diagnosis"                        = data_diag$`Prior Diagnosis`,
  "Radiation Therapy"                      = data_diag$`Radiation Therapy`,
  "Primary Lymph Node Assessment"          = data_diag$`Primary Lymph Node Presentation Assessment`,
  "Person Neoplasm Status"                 = data_diag$`Person Neoplasm Cancer Status`,
  "New Neoplasm Event"                     = data_diag$`New Neoplasm Event Post Initial Therapy Indicator`,
  "Histologic Grade"                       = data_diag$`Neoplasm Histologic Grade`,
  "ICD-10 Classification"                  = data_diag$`ICD-10 Classification`
)

sorted_list <- lapply(diagnosis_list_categorical, sort_data)

n_distinct_list <- sapply(diagnosis_list_categorical, function(diagnosis) length(unique(na.omit(diagnosis))))

diagnosis_categorical_summary <- data.frame(
  n_distinct = as.numeric(n_distinct_list),
  Types    = unlist(sorted_list),
  stringsAsFactors = FALSE
)

diagnosis_categorical_summary
#---------------
```

## Comparative Analysis of Variables Within a Common Theme

In our dataset (divided ones), multiple variables often classify similar attributes or quantify related parameters, so it is essential to analyze the correlations between these variables to uncover their relationships and potential interdependencies.

Furthermore, some variables may not be meaningful for analysis. For example, nominal variables that overwhelmingly dominate the dataset, where one category accounts for the vast majority of observations, may offer limited insight and can be excluded from detailed examination.

### Race, Genetic Ancestry Label, and Ethnicity Category

Race, Genetic Ancestry Label, and Ethnicity Category strongly overlap in our data, with most individuals of European ancestry also classified as White and similar by ethnicity. This high correlation limits diversity across subgroups, rendering analyses stratified by these categories unreliable for drawing meaningful conclusions.

```{r}
data_metrics |> 
  ggplot(mapping = 
           aes(x = `Race Category`,
               fill = `Ethnicity Category`)) +
  geom_bar(position = position_dodge(preserve = "single"), color = "black", alpha = 0.7) +
  geom_vline(xintercept = seq(0.5, length(unique(data_metrics$`Race Category`)) + 0.5, by = 1), linetype = "dashed") +
  theme_minimal()
```

This was kinda proven by the tables above, but we build on it to show off correlation.
