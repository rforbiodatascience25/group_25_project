---
title: "07_analysis_3"
format:
  html:
    embed-resources: true
editor: visual
---

## Loading Libraries

Load in the necessary libraries.

```{r}
library("tidyverse")
library("here")
library("ggridges")
library("ggalluvial")
```

## Loading data

Load in the data from the augmentation step *03_augment*.

```{r}
#| echo: true
#| eval: true
#| message: false

data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

## Load in Visual Guidelines

## Plots

### Average Standardized biological scores (Aneuploidy, hypoxia, MSI) Across Age Groups Divided by Sex

From the total plot we can see that males in general had higher MSI Mantis Scores, both sexes had their highest MSI Mantis Scores at 30-40, and that women had the lowest of all scores at 80-90. It is interesting to note that females had very low Ragnum and Buffa Hypoxia Scores in the age group of 30-40, while men had higher Buffa Hypoxia Scores at both 30-40 and 80-90. Men also had the lowest scores for all MSI Sensor Scores at 30-40 and 80-90.

From the two plots based on disease specific survival status, we can see that in general, across all sexes and sexes, those who died with tumor had lower scores, often in the negatives. While those who were alive or died without tumor followed the trend of females had very low Ragnum and Buffa Hypoxia Scores in the age group of 30-40, those who died with tumor did not. Those who were alive or dead tumor free also followed the trend of males having high MSI Mantis Scores and Buffia Hypoxia Scores at 30-40.

```{r}
#| fig-width: 10
#| fig-height: 6

data_score |>
  left_join(data_metrics |>
  select(`Patient ID`,
    Age_Group,
    Sex),
    by = "Patient ID") |>
  mutate(across(c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    ~ scale(.)[, 1])) |>
  pivot_longer(cols = c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    names_to = "Metric",
    values_to = "Score") |>
  drop_na(Score,
    Age_Group,
    Sex) |> 
  group_by(Age_Group,
    Sex,
    Metric) |>
  summarise(Mean_Z = mean(Score,
    na.rm = TRUE),
    .groups = "drop") |>
  ggplot(aes(x = Age_Group,
    y = Metric,
    fill = Mean_Z)) +
  geom_tile(color = "gray90") +
  geom_text(aes(label = round(Mean_Z, 2)),
    color = "black",
    fontface = "bold",
    size = 4) +
  scale_fill_uniform_continuous +
  scale_x_discrete(expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) +
  facet_wrap(~ Sex) +
  labs(title = "Standardized Scores by Age Group (Total)",
    x = "Age Group",
    y = "Metric",
    fill = "Mean Z-Score") +
  theme_uniform() +
  theme(axis.text.x = element_text(angle = 45))

data_score |>
  left_join(data_metrics |> 
  select(`Patient ID`,
    Age_Group,
    Sex),
    by = "Patient ID") |>
  left_join(data_diag |> 
  select(`Patient ID`,
    `Disease-specific Survival status (des)`),
    by = "Patient ID") |>
  filter(`Disease-specific Survival status (des)` == "1:DEAD WITH TUMOR") |>
  mutate(across(c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    ~ scale(.)[, 1])) |>
  pivot_longer(cols = c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    names_to = "Metric",
    values_to = "Score") |>
  drop_na(Score,
    Age_Group,
    Sex) |>
  group_by(Age_Group,
    Sex,
    Metric) |>
  summarise(Mean_Z = mean(Score,
    na.rm = TRUE),
    .groups = "drop") |>
  ggplot(aes(x = Age_Group,
    y = Metric,
    fill = Mean_Z)) +
  geom_tile(color = "gray90") +
  geom_text(aes(label = round(Mean_Z, 2)),
    color = "black",
    fontface = "bold",
    size = 4) +
  scale_fill_uniform_continuous +
  scale_x_discrete(expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) +
  facet_wrap(~Sex) +
  labs(title = "Standardized Scores by Age Group (Dead With Tumor)",
    x = "Age Group",
    y = "Metric",
    fill = "Mean Z-Score") +
  theme_uniform() +
  theme(axis.text.x = element_text(angle = 45))


data_score |>
  left_join(data_metrics |> 
  select(`Patient ID`,
    Age_Group, Sex),
    by = "Patient ID") |>
  left_join(data_diag |> 
  select(`Patient ID`,
    `Disease-specific Survival status (days)`),
    by = "Patient ID") |>
  filter(`Disease-specific Survival status (days)` == "0:ALIVE OR DEAD TUMOR FREE") |>
  mutate(across(c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    ~ scale(.)[, 1])) |>
  pivot_longer(cols = c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    names_to = "Metric",
    values_to = "Score") |>
  drop_na(Score,
    Age_Group,
    Sex) |>
  group_by(Age_Group,
    Sex,
    Metric) |>
  summarise(Mean_Z = mean(Score,
    na.rm = TRUE),
    .groups = "drop") |>
  ggplot(aes(x = Age_Group,
    y = Metric,
    fill = Mean_Z)) +
  geom_tile(color = "gray90") +
  geom_text(aes(label = round(Mean_Z, 2)),
    color = "black",
    fontface = "bold",
    size = 4) +
  scale_fill_uniform_continuous +
  scale_x_discrete(expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) +
  facet_wrap(~ Sex) +
  labs(title = "Standardized Scores by Age Group (Alive or Dead Tumor Free)",
    x = "Age Group",
    y = "Metric",
    fill = "Mean Z-Score") +
  theme_uniform() +
  theme(axis.text.x = element_text(angle = 45))

```
