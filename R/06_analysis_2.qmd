---
title: "06_analysis_2"
format:
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
library("patchwork")
library("tidyverse")
library("ggplot2")
library("corrplot")
library("here")
```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
#| message: false
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

## Visual Guidelines

```{r}
theme_uniform <- function(base_size = 14, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      plot.title    = element_text(face = "bold", size = base_size + 2, hjust = 0),
      axis.title    = element_text(face = "bold"),
      axis.text     = element_text(color = "gray20"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(color = "gray90", size = 0.3),
      strip.text    = element_text(face = "bold"),
      strip.background = element_rect(fill = "gray95", color = NA),
      legend.position = "right",
      legend.title = element_text(face = "bold"),
      plot.margin = margin(10, 10, 10, 10)
    )
}

#colorblind-safe color PALETTE
#pick values for color and fill
palette <- c(
  "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7"
)

#colorblind-safe color GRADIENTS
scale_fill_uniform_continuous  <- scale_fill_gradientn(
  colors = c("#2166AC", "#F7F7F7", "#B2182B")
)
scale_color_uniform_continuous <- scale_color_gradientn(
  colors = c("#2166AC", "#F7F7F7", "#B2182B")
)

#geometry defaults
update_geom_defaults("line",   list(linewidth = 1))
update_geom_defaults("point",  list(size = 2, stroke = 0.5))
update_geom_defaults("boxplot", list(linewidth = 0.6))
update_geom_defaults("violin",  list(linewidth = 0.6))

#presentation settings
presentation_fig_width  <- 7
presentation_fig_height <- 4.5
presentation_dpi        <- 200

#aspect ratios
aspect_wide    <- c(width = 7,  height = 4)   #wide (16:9) for time series / line plots:
aspect_square  <- c(width = 5,  height = 5)   #square (1:1) for correlations & scatter:
aspect_tall    <- c(width = 5,  height = 7)   #tall (3:4) for barplots with long labels:

#annotation settings high contrast
annotation_text <- list(color = "black", size = 5, fontface = "bold")

#remove excess padding
scale_y_continuous_uniform <- scale_y_continuous(expand = expansion(mult = c(0, 0.05)))
scale_x_continuous_uniform <- scale_x_continuous(expand = expansion(mult = c(0.02, 0.02)))
```

## Data Description/ Notes for Analysis

Summary of the data:

-   **data_metrics** — patient demographics (age, sex, race, ancestry)
-   **data_gene** — genomic instability metrics (mutation count, TMB, fraction genome altered).
-   **data_score** — biological scores (aneuploidy, hypoxia, MSI).
-   **data_code** — cancer staging and clinical classification codes.
-   **data_diag** — diagnoses, survival outcomes, therapy history.

## Genomic Alterations & Instability Analysis (**data_gene)**

### Relationship between continuous genomic instability measures and overall survival (days)

```{r}
#| fig-width: 15
#| fig-height: 7

# Joining tables and filter out outliers
data_gene_diag <- full_join(data_gene, data_diag, by = "Patient ID")

# Reshape to Long Dataset
data_long <- data_gene_diag |>
  mutate(
    TMB = `TMB (nonsynonymous)`,
    MutCount = `Mutation Count`,
    FracGenome = `Fraction Genome Altered`,
    TumorLoad = `Tumor Break Load`
  ) |>
  pivot_longer(
    cols = c(TMB, MutCount, FracGenome, TumorLoad),
    names_to = "Metric",
    values_to = "Value"
  )

# Compute medians per metric
medians <- data_long |>
  group_by(Metric) |>
  summarize(med = median(Value, na.rm = TRUE))

data_long <- data_long |>
  left_join(medians, by = "Metric") |>
  mutate(
    Group = case_when(
      Value > med ~ "Higher Genomic Instability",
      Value <= med ~ "Lower Genomic Instability"
      ),
    Metric = factor(
      Metric,
      labels = c(
        "TMB (nonsynonymous)",
        "Mutation Count",
        "Fraction Genome Altered",
        "Tumor Break Load"
      )))

## PLOTTING
# Scatter/LOESS Plot
plt_scatter <- ggplot(
  data_long,
  aes(x = `Overall Survival (days)`, 
      y = Value, 
      color = Group)
) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "blue") +
  facet_wrap(~ Metric, scales = "free_y") +
  theme_uniform() +
  labs(title = "Overall Survival vs Genomic Metrics")

# Present Plots
plt_scatter
```

Survival distributions indicate that higher genomic instability, particularly for Mutation Count, Fraction Genome Altered, and Tumor Break Load, is generally associated with slightly shorter survival, although the limited sample size in the longer-survival range may affect this The same analysis suggests that for TMB, the very highest values may correspond to longer survival, although the same sample size limitation is present.

As shown by both the scatter plot and descriptive statistics, Mutation Count and TMB (nonsynonymous) are highly correlated, with very similar distributions. Therefore, from this point forward only Mutation Count was visualized, since plotting both variables would not provide any additional insight.

### **Tumor types and Genomic differences across them (not meaningful for further analysis)**

-   **Context**: This section compares genomic instability metrics (Mutation Count, TMB, Fraction Genome Altered, Tumor Break Load) across different tumor types, to determine the existance of big difference between them.

-   **Analysis from Plots**: The 'Ductal Adenocarcinoma' appears to have lower fraction of the genome altered and a slight higher tumor break load compared to others subtypes, altough the differences are very discrete. The other tumor types were discarded due to lack of data.

```{r}
#| fig-width: 12
#| fig-height: 5

data_gene_diag |>
  filter(
    `Tumor Type` %in% c(
      "Pancreas Adenocarcinoma, Ductal Type",
      "Pancreas Adenocarcinoma, Other Subtype"
    )
  ) |>
  pivot_longer(
    cols = c(
      `Mutation Count`,
      `Fraction Genome Altered`,
      `Tumor Break Load`
    ),
    names_to = "Metric",
    values_to = "Value"
  ) |>
  ggplot(aes(x = `Tumor Type`, y = Value, fill = `Tumor Type`)) +
  geom_boxplot() +
  facet_wrap(~ Metric, nrow = 1, scales = "free_y") +
  theme_uniform() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank()
  )
```

### Distribution of Cancer Stages and Genomic Instability

-   **Context**: Cancer stage reflects the extent of tumor progression, while genomic instability measures (Mutation Count, Fraction Genome Altered, and Tumor Break Load) capture different aspects of chromosomal and genetic instability. These features are often associated with tumor aggressiveness and poor prognosis. This set of plots explores how cancer stage distributions relate to genomic instability across pancreatic adenocarcinoma subtypes (Ductal Type vs Other Subtypes).

-   The stage distribution plot in describe shows a concentration of patients in **Stage IIB**, indicating the dataset is heavily skewed toward mid-stage disease.

```{r}
data_gene_code = full_join(data_gene, data_code, by = "Patient ID")
```

```{r}
# 1) Find stages with > 10 samples
stages_keep <- data_gene_code |>
  rename(NDSA_stage = `Neoplasm Disease Stage American Joint Committee on Cancer Code`) |>
  count(NDSA_stage, name = "n_samples") |>
  filter(n_samples > 10)

# 2) Labels
stage_labels <- stages_keep |>
  mutate(stage_label = paste0(NDSA_stage, " (n=", n_samples, ")")) |>
  select(NDSA_stage, stage_label)

# 2) Keep full data only for those stages
data_gene_code_filtered <- data_gene_code |>
  rename(NDSA_stage = `Neoplasm Disease Stage American Joint Committee on Cancer Code`) |>
  filter(!is.na(NDSA_stage)) |> 
  semi_join(stages_keep, by = "NDSA_stage") 
```

```{r}
#| fig-width: 5
#| fig-height: 10
data_gene_code_filtered |>
  left_join(stage_labels, by = "NDSA_stage") |>
  pivot_longer(
    cols = c(
      `Fraction Genome Altered`,
      `Mutation Count`,
      `Tumor Break Load`
    ),
    names_to = "Genomic_Metric",
    values_to = "Value"
  ) |>
  ggplot(aes(x = stage_label, y = Value)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  facet_wrap(~ Genomic_Metric, 
             scales = "free_y", 
             ncol = 1) +
  theme_uniform() +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1)) +
  labs(
    x = "AJCC stage (n per stage)",
    y = "Genomic metric",
    title = "Genomic instability metrics across AJCC stages")
```

To begin, we only included tumor classes with at least 10 patients per AJCC stage, as smaller groups would not provide a reliable representation of the underlying distribution.

-   There’s considerable overlap between neighboring stages, so stage alone doesn’t perfectly separate genomic burden.

-   One could say that Tumor Break Load tends to increase with tumor stage, as indicated by higher medians and a wider spread of values in the boxplots for advanced stages.

-   **TBL measures:** it is the sum of unbalanced structural-variant breakpoints, a quantitative readout of **Structural Variants driven chromosomal instability**.

-   So, *in theory*, as tumors accumulate Structural Variants and copy‑number chaos over time, **TBL should rise**, and high TBL is often seen in more aggressive, later‑stage or poorer‑prognosis disease.

### Heatmap of the pairwise correlations between genomic instability and hypoxia-related metrics

```{r}
#| fig-width: 10
#| fig-height: 6

data_full <- data_gene |>
  full_join(data_score, by = "Patient ID") |>
  full_join(data_diag, by = "Patient ID") |>
  full_join(data_metrics, by = "Patient ID")

# Select  columns of interest
cols_to_compare <- c("TMB (nonsynonymous)", "Mutation Count", 
                     "Fraction Genome Altered", "Tumor Break Load",
                     "Aneuploidy Score", "Buffa Hypoxia Score",
                     "MSI MANTIS Score", "MSIsensor Score",
                     "Ragnum Hypoxia Score", "Winter Hypoxia Score")

data_numeric <- data_full |> 
  select(all_of(cols_to_compare))

correl_matrix <- cor(data_numeric |>
                    select(cols_to_compare), 
                    use = "complete.obs")

corrplot(correl_matrix, method = "color",tl.col = "black")

```

This plot was used to assess relationships between genomic instability metrics and hypoxia scores. Focusing on the first four columns (genomic instability measures) and the last six rows (hypoxia scores), no strong blue stand out, indicating that hypoxia scores are not strongly correlated with the genomic instability variables in this dataset.

## Biological scores Analysis (data_score)

### Distribution of Aneuploidy Scores across different Cancer Stages

```{r}
#| fig-width: 10
#| fig-height: 6

# Relate Cancer Stage with Aneuploidy Score
plt_aneuploidy_stage <- data_code |>
  full_join(data_score, by = "Patient ID") |> 
  rename(`Cancer Stage` = `Neoplasm Disease Stage American Joint Committee on Cancer Code`) |>
  drop_na("Cancer Stage") |>
  ggplot(aes(x = `Cancer Stage`, 
             y = `Aneuploidy Score`, 
             fill = `Cancer Stage`)) +
  geom_boxplot() +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) +
  ggtitle("Aneuploidy Score by Cancer Stage") +
  theme_uniform() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plt_aneuploidy_stage
```

The Aneuploidy Score, which quantifies chromosomal instability and is often linked to tumor aggressiveness and poor prognosis, was analyzed to assess whether higher cancer stages correspond to increased chromosomal abnormalities. The plot shows no clear increase in Aneuploidy Score with advancing stage, which may reflect the limited stage diversity in the dataset, particularly the small number of Stage I cases.

### MSI and Hypoxia congruency

```{r}
#| fig-width: 10
#| fig-height: 6
metric_for_order_msi     <- "MSIsensor Score"
metric_for_order_hypoxia <- "Winter Hypoxia Score"

# Long + scaled (as before)
df_long <- data_score |>
  select(`Patient ID`,
         `MSI MANTIS Score`,
         `MSIsensor Score`,
         `Buffa Hypoxia Score`,
         `Ragnum Hypoxia Score`,
         `Winter Hypoxia Score`) |>
  drop_na() |>
  pivot_longer(
    cols = -`Patient ID`,
    names_to = "Metric",
    values_to = "Score"
  ) |>
  group_by(Metric) |>
  mutate(
    Score_scaled = (Score - mean(Score, na.rm = TRUE)) /
                   sd(Score, na.rm = TRUE)
  ) |>
  ungroup()

# MSI: order by MSI metric
df_msi <- df_long |>
  filter(Metric %in% c("MSI MANTIS Score", "MSIsensor Score")) |>
  group_by(`Patient ID`) |>
  mutate(
    order_value = Score_scaled[Metric == metric_for_order_msi][1]
  ) |>
  ungroup() |>
  mutate(
    `Patient ID` = fct_reorder(`Patient ID`, order_value, .desc = TRUE)
  )

# Hypoxia: order by Winter hypoxia
df_hypoxia <- df_long |>
  filter(Metric %in% c("Buffa Hypoxia Score",
                       "Ragnum Hypoxia Score",
                       "Winter Hypoxia Score")) |>
  group_by(`Patient ID`) |>
  mutate(
    order_value = Score_scaled[Metric == metric_for_order_hypoxia][1]
  ) |>
  ungroup() |>
  mutate(
    `Patient ID` = fct_reorder(`Patient ID`, order_value, .desc = TRUE)
  )

MSI_heatmap <- ggplot(df_msi,
       aes(x = `Patient ID`, y = Metric, fill = Score_scaled)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_uniform() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(
    title = "MSI scores across patients (z-scaled)",
    x = "Patient", y = "MSI metric", fill = "z-score"
  )

hypoxia_heatmap <- ggplot(df_hypoxia,
       aes(x = `Patient ID`, y = Metric, fill = Score_scaled)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_uniform() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(
    title = "Hypoxia scores across patients (z-scaled)",
    x = "Patient", y = "Hypoxia metric", fill = "z-score"
  )

MSI_heatmap / hypoxia_heatmap
```

These heatmaps show how MSI and hypoxia scores vary across patients after z‑scaling. In the MSI panel, most patients cluster around low MSI values with only a minority showing high MSI z‑scores, consistent with MSI‑high tumors being relatively rare. In contrast, the hypoxia panel displays a broader spread and more gradual gradients across patients, suggesting greater heterogeneity in hypoxia signatures than in MSI status.

These heatmaps indicate poor agreement between the different hypoxia and MSI scoring methods at the individual-patient level. Apart from Buffa and Winter, which show relatively similar patterns, the remaining signatures often assign very different relative scores to the same patients, suggesting that the choice of scoring method can substantially change which tumors are labeled as hypoxic or MSI-high and that these methods are not interchangeable.

### Score Distribution Along Neoplasm Histological Grades Divided by Cancer Status

For the Buffia Hypoxia Scores, both statuses had increasing trends as Grades went up, with those who had tumors having generally larger scores. For the MSI Mantis Scores, there didn't seem to be a particular trend for those who did not have tumors. But for those who had a tumor, there was a decreasing trend as Grades went up. For the MSI Sensor Scores, those who did not have tumors had a slight increasing trend as Grades went up, while those who had tumors did not seem to follow a trend. Lastly, for Ragnum Hypoxia Scores, both those who had tumors and who did not have tumors had an increasing trend as Grades went up. Other than G1, those who had tumors had higher scores than those who did not.

```{r}
#| fig-width: 10
#| fig-height: 6
data_score |>
  left_join(data_diag |>
  select(`Patient ID`,
    `Neoplasm Histologic Grade`,
    `Person Neoplasm Cancer Status`),
    by = "Patient ID") |>
  filter(!is.na(`Neoplasm Histologic Grade`),
    !`Neoplasm Histologic Grade` %in% c("GX", "G4")) |>
  pivot_longer(cols = c(`Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `MSI MANTIS Score`,
    `MSIsensor Score`),
    names_to  = "Metric",
    values_to = "Score") |>
  filter(!is.na(Score),
    !is.na(`Neoplasm Histologic Grade`),
    !is.na(`Person Neoplasm Cancer Status`)) |>
  ggplot(aes(x = `Neoplasm Histologic Grade`,
    y = Score,
    fill = `Person Neoplasm Cancer Status`)) +
  geom_boxplot(alpha = 0.7,
    outlier.shape = NA) +
  facet_wrap(~ Metric,
    scales = "free_y") +
  scale_fill_manual(values = palette) +
  scale_y_continuous_uniform +
  scale_x_discrete(expand = expansion(mult = c(0.02, 0.02))) +
  labs(title = "Distribution of Scores Across Histologic Grades by Cancer Status",
    x = "Neoplasm Histologic Grade",
    y = "Score",
    fill  = "Cancer Status") +
  theme_uniform()
```

## Diagnostic, Survival (data_diag)

### Patient Survival Comparison with Radiation Therapy and Prior Diagnosis

```{r}
#| fig-width: 10
#| fig-height: 6
data_diag |> 
  drop_na(`Prior Diagnosis`,
    `Disease-specific Survival status (des)`,
    `Radiation Therapy`) |> 
  count(Prior_Diagnosis = `Prior Diagnosis`,
    Radiation_Therapy = `Radiation Therapy`,
    Survival = `Disease-specific Survival status (des)`) |> 
  group_by(Survival) |> 
  mutate(percentage = n / sum(n) * 100) |> 
  ggplot(aes(x = Prior_Diagnosis,
    y = Radiation_Therapy,
    fill = n)) +
  geom_tile() +
  geom_text(aes(label = paste0(n,
    "\n(",
    round(percentage,
    1), "%)")),
    color = "black",                     
    size  = 4,
    fontface = "bold") +
  facet_wrap(~ Survival) +
  scale_fill_uniform_continuous +       
  labs(title = "Patient Survival by Prior Diagnosis and Radiation Therapy",
    x  = "Prior Diagnosis",
    y = "Radiation Therapy",
    fill = "Count") +
  theme_uniform()

```

It can be seen that for those who had neither a prior diagnosis or radiation therapy and for those who did not have radiation therapy but did have a prior diagnosis, there was a nearly 50-50 split on their survival status. However, for those that did have radiation therapy but did not have a prior diagnosis, there was a near 70-30 split on survival status. Due to the small number of patients who did not fit into the category of no radiation therapy and no prior diagnosis, these numbers may not necessarily be trustworthy. However, in general, this does follow the trend we would expect to see, where those who were not previously sick and who did go through with the therapy would be more likely to survive. It is interesting to see that prior diagnosis status did not seem to show much of an impact on survival status.

### Age Density Between Sexes Across Neoplasm Histologic Grades

```{r}
#| fig-width: 10
#| fig-height: 6
bind_cols(data_metrics |> 
  select(Age = `Diagnosis Age`,
    Sex),
    data_diag |> 
  select(Neo_Grade = `Neoplasm Histologic Grade`)) |> 
  filter(!Neo_Grade %in% c("GX",
    "G4")) |> 
  ggplot(aes(x = Age,
    y = Neo_Grade,
    fill = Neo_Grade,
    color = Neo_Grade)) +
  geom_density_ridges(alpha = 0.6,
    linewidth = 0.6) +
  facet_wrap(~ Sex) +
  scale_fill_manual(values = palette) +
  scale_color_manual(values = palette) +
  scale_x_continuous_uniform + 
  scale_y_discrete(expand = expansion(mult = c(0.05,
    0.05))) +
  labs(title = "Age Distribution Across Neoplasm Histologic Grades",
    x = "Diagnosis Age",
    y = "Histologic Grade",
    fill = "Grade") +
  theme_uniform() +
  theme(legend.position = "none")
```

GX was removed due to there being only 3 instances of it and also that it represents an inability to properly assign a grade. G4 was removed due to there being only 2 instances and therefore not being able to show statistically significant data.

This plot shows that in both men and women, in all 3 grades, a majority of samples were between the 40 to 80 age range. However, it is interesting to note, that in general, density was highest for females in all grades slightly before males. In G1 females seem to peak in their mid-60s, in G2 the peak is near early-70s, and in G3 the peak is near early-60s. For men however, in G1 the peak is near early-70s, in G2 the peak is also near early-70s, and for G3 the peak is near mid-70s. Along with this difference in ages between the sexes, it is also interesting to note that G3 is found more commonly at a younger age than G1 or G2. This could be important to note as it shows that a more advanced cancer being found in younger women.
