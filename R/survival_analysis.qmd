---
title: "Survival Analysis"
format:
  html:
    embed-resources: true
editor: visual
---

## **Loading libraries**

```{r}
library("patchwork")
library("tidyverse")
library("ggplot2")
library("corrplot")
library("here")

```

## **Loading data**

Loading the data from the previous augmentation step *03_augment*.

```{r}
#| message: false
data_metrics <- read_tsv(here("data","data_metrics_aug.tsv"))
data_gene <- read_tsv(here("data","data_gene_aug.tsv"))
data_score <- read_tsv(here("data","data_score_aug.tsv"))
data_code <- read_tsv(here("data","data_code_aug.tsv"))
data_diag <- read_tsv(here("data","data_diag_aug.tsv"))
```

## **Plotting data**

#### Genomic Plot

-   **Goal**: See if the patients with the highest mutation burdens are the ones surviving or dying

-   **Analysis of the plots**: Overall no correlation between the high values of the genomic instability and the status (dead with tumor or alive/ death tumor free). Surprisingly, the higher fraction of genome altered corresponded to a status of alive/ dead tumor free.

```{r}
#| fig.width=30
#| fig.height=6


# Preparing the data
data_full <- data_gene |>
  full_join(data_diag, by = "Patient ID") |>
  drop_na(`Disease-specific Survival status (des)`) |>
  mutate(Status = `Disease-specific Survival status (des)`)

#  Colors to separate cancer status
status_colors <- c(
  "DEAD WITH TUMOR" = "red",
  "ALIVE OR DEAD TUMOR FREE" = "#2ECC71"
)

## Plotting
# Plot - Mutation Count
plt_mut_count <- data_full |>
  filter(`Mutation Count` < 5000) |>
  arrange(desc(`Mutation Count`)) |>
  mutate(Patient_Order = factor(`Patient ID`, 
                                levels = `Patient ID`))|>
  ggplot(aes(x = Patient_Order, 
             y = `Mutation Count`, 
             fill = Status)) +
  geom_col(width = 1) +
  scale_fill_manual(values = status_colors) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(title = "Mutation Count vs Survival",
       x = "Patients", 
       y = "Mutation Count")


# Plot - Tumor Break Load
plt_tbl <- data_full |>
  filter(`Tumor Break Load` < 300) |>
  arrange(desc(`Tumor Break Load`)) |>
  mutate(Patient_Order = factor(`Patient ID`, 
                                levels = `Patient ID`))|>
  ggplot(aes(x = Patient_Order, 
             y = `Tumor Break Load`, 
             fill = Status)) +
  geom_col(width = 1) +
  scale_fill_manual(values = status_colors) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(title = "Tumor Break Load vs Survival",
       x = "Patients", 
       y = "Tumor Break Load")


# Plot - TMB (nonsynonymous)
plt_tmb <- data_full |>
  filter(`TMB (nonsynonymous)` < 400) |>
  arrange(desc(`TMB (nonsynonymous)`)) |>
  mutate(Patient_Order = factor(`Patient ID`, 
                                levels = `Patient ID`)) |>
  ggplot(aes(x = Patient_Order, 
             y = `TMB (nonsynonymous)`, 
             fill = Status)) +
  geom_col(width = 1) +
  scale_fill_manual(values = status_colors) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(title = "TMB (nonsynonymous) vs Survival",
       x = "Patients", 
       y = "TMB (nonsynonymous)")


# Fraction Genome Altered (FGA) - Plot
plt_fga <- data_full |>
  arrange(desc(`Fraction Genome Altered`)) |>
  mutate(Patient_Order = factor(`Patient ID`, 
                                levels = `Patient ID`))|>
  ggplot(aes(x = Patient_Order, 
             y = `Fraction Genome Altered`, 
             fill = Status)) +
  geom_col(width = 1) +
  scale_fill_manual(values = status_colors) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(title = "Fraction Genome Altered vs Survival",
       x = "Patients", 
       y = "Fraction Genome Altered")


# Combine plots
(plt_mut_count/ plt_tmb ) 
(plt_tbl/ plt_fga)
```

#### Interaction between Hypoxia and TMB

-   **Analysis before**: high TMB might correlate with survival, and Hypoxia scores also matter. This plot checks the interaction -\> see if patients with High Hypoxia AND High TMB have the worst survival?

```{r}
#| fig.width=8
#| fig.height=6

# Prepare data
data_heatmap <- data_gene |>
  full_join(data_diag, by = "Patient ID") |>
  full_join(data_score, by = "Patient ID") |>
  filter(`TMB (nonsynonymous)` < 400) |>
  select(`TMB (nonsynonymous)`, 
         `Buffa Hypoxia Score`, 
         `Overall Survival (days)`) |>
  drop_na() |>
  mutate(
    TMB_Bin = case_when(
      `TMB (nonsynonymous)` > median(`TMB (nonsynonymous)`, na.rm = TRUE) ~ "High TMB",
      `TMB (nonsynonymous)` <= median(`TMB (nonsynonymous)`, na.rm = TRUE) ~ "Low TMB"),
    Hypoxia_Bin = case_when(
      `Buffa Hypoxia Score` > median(`Buffa Hypoxia Score`, na.rm = TRUE) ~ "High Hypoxia",
      `Buffa Hypoxia Score` <= median(`Buffa Hypoxia Score`, na.rm = TRUE) ~ "Low Hypoxia"))|>
  group_by(TMB_Bin, Hypoxia_Bin) |>
  summarise(Median_Survival = median(`Overall Survival (days)`), .groups = 'drop')

# Plot Heatmap
ggplot(data_heatmap, aes(x = TMB_Bin, 
                         y = Hypoxia_Bin, 
                         fill = Median_Survival)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(Median_Survival, 0)), 
            color = "white", 
            size = 6) +
  scale_fill_gradient(
    low = "red",
    high = "#2ECC71",
    name = "Median Survival (Days)"
  ) + 
theme_minimal() + 
theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text = element_text(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title = "Median Overall Survival (Days)",
    subtitle = "Interaction between TMB and Hypoxia (Buffa)",
    fill = "Median Survival",
    x = "TMB (nonsynonymous)", 
    y = "Ragnum Hypoxia Score"
  )
```

#### Interaction between Hypoxia/ Radiotherapy/ Overall survival

-   **Context**: Continuation of the Last Hypoxia/ Radiotherapy/ Survival Analysis

-   **Analysis from plot**: Significantly higher survival from patients with radiotherapy treatment and low hypoxia. This follows the results observed in the last plots and with the literature. However, the radiotherapy treatment of patients with high hypoxia has higher survival values than low hypoxia with no treatment, which means that, idependently og

```{r}
#| fig.width=15
#| fig.height=8

# Data preparing
data_hypoxia <- data_diag |>
  full_join(data_code, by = "Patient ID") |>
  full_join(data_score, by = "Patient ID") |>
  select(
    PatientID = `Patient ID`,
    `Buffa Hypoxia Score`,
    `Ragnum Hypoxia Score`,
    `Winter Hypoxia Score`,
    `Radiation Therapy`,
    `Overall Survival (days)`,
  ) |>
  drop_na(`Buffa Hypoxia Score`,`Ragnum Hypoxia Score`,
    `Winter Hypoxia Score`,`Radiation Therapy`, `Overall Survival (days)`)
  

# Hypoxia Groups
# Calculate the median Ragnum
hyp_med <- median(data_hypoxia[["Ragnum Hypoxia Score"]], na.rm = TRUE)

data_hypoxia <- data_hypoxia |>
  mutate(
    Hypoxia_Group = case_when(
      `Ragnum Hypoxia Score` > hyp_med ~ "High Ragnum Hypoxia",
      `Ragnum Hypoxia Score` <= hyp_med ~ "Low Ragnum Hypoxia"
    ),
    Radiation_Group = `Radiation Therapy`
  )

# Aggregate Data for Heatmap 
# Group by the two variables and calculate the Median Overall Survival
data_heatmap_RT <- data_hypoxia |>
  group_by(Radiation_Group, Hypoxia_Group) |>
  summarise(
    Median_Survival = median(`Overall Survival (days)`),
    .groups = 'drop'
  )

# Plot Heatmap
ggplot(data_heatmap_RT, aes(x = Radiation_Group,
                            y = Hypoxia_Group, 
                            fill = Median_Survival)) +
  geom_tile(color = "white") +
  geom_text(aes(label = str_c(round(Median_Survival, 0))), 
            color = "white", 
            size = 5,
            fontface = "bold") +
  scale_fill_gradient(
    low = "red",
    high = "#2ECC71",
    name = "Median Survival (Days)"
  ) + 
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title = "Median Overall Survival (Days) by Hypoxia and Radiotherapy",
    x = "Radiation Therapy Received",
    y = "Ragnum Hypoxia Score"
  )
```

#### Interaction between Diagnosis Age and Overall survival

```{r}
#| fig.width=30
#| fig.height=6


# Preparing the data
data_waterfall <- data_metrics |>
  full_join(data_diag, by = "Patient ID") |>
  drop_na(`Disease-specific Survival status (des)`) |>
  mutate(Status = `Disease-specific Survival status (des)`)

#  Colors to separate cancer status
status_colors <- c(
  "DEAD WITH TUMOR" = "red",
  "ALIVE OR DEAD TUMOR FREE" = "#2ECC71"
)

## Plotting
plt_age_surv <- data_waterfall |>
  arrange(desc(`Diagnosis Age`)) |>
  mutate(Patient_Order = factor(`Patient ID`, 
                                levels = `Patient ID`))|>
  ggplot(aes(x = Patient_Order, 
             y = `Diagnosis Age`, 
             fill = Status)) +
  geom_col(width = 1) +
  scale_fill_manual(values = status_colors) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(title = "Diagnosis Age vs Survival",
       x = "Patients", 
       y = "Diagnosis Age")
plt_age_surv

```

#### Kaplan-Meier survival analysis based on **Diagnosis Age**

```{r}

data_age <- data_diag |>
  full_join(data_metrics, by = "Patient ID")

## Select and clean necessary columns
data_age <- data_age |>
  select(
    PatientID = `Patient ID`,
    Diagnosis_Age = `Diagnosis Age`, 
    `Overall Survival (days)`,
    Status_Tumor = `Disease-specific Survival status (bin)` 
  ) |>
  drop_na(
    Diagnosis_Age,
    `Overall Survival (days)`,
    Status_Tumor
  )

## Define Age Groups (Low vs High) using the median
age_med <- median(data_age[["Diagnosis_Age"]], na.rm = TRUE)

data_age <- data_age |>
  mutate(
    Age_Group = case_when(
      Diagnosis_Age > age_med ~ "High Age",
      Diagnosis_Age <= age_med ~ "Low Age"
    )
  )


# Survival Calculation (Kaplan-Meier) 
## Calculation of Kaplan-Meier
Kaplan_meier_calc_age <- data_age |>
  select(
    time = `Overall Survival (days)`,
    status = Status_Tumor,
    group = Age_Group
  ) |>
  arrange(group, time) |>
  group_by(group, time, status) |>
  tally() |>
  pivot_wider(
    names_from = status,
    values_from = n,
    values_fill = 0
  ) |>
  rename(events = `1`, censored = `0`) |> 
  group_by(group) |>
  mutate(
    # n_risk-> Calculate number at risk by summing all future events + censored
    n_risk = rev(cumsum(rev(events + censored))),
    # surv_step-> Calculate probability of survival at this time point
    surv_step = 1 - events / n_risk,
    # surv > Cumulative of surv_step gives the KM estimate
    surv = cumprod(surv_step)
  ) |>
  ungroup()

# Plot KM Curve 
ggplot(Kaplan_meier_calc_age, aes(x = time,
                                  y = surv,
                                  color = group)) +
  geom_step(linewidth = 1.1) +
  scale_color_manual(
    values = c("High Age" = "#E74C3C", 
               "Low Age" = "#3498DB") ) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(
    title = "Survival of Patients\nHigh vs Low Diagnosis Age",
    x = "Overall Survival Time (days)",
    y = "Survival Probability",
    color = "Diagnosis Age Group"
  )
```

#### Kaplan-Meier survival analysis based on **Diagnosis Age and Tumor Type**

```{r}

# Define Data
data_age_tumor <- data_diag |>
  full_join(data_metrics, by = "Patient ID") |>
  select(
    PatientID = `Patient ID`,
    Diagnosis_Age = `Diagnosis Age`, 
    `Overall Survival (days)`,
    Status_Tumor = `Disease-specific Survival status (bin)`,
    Tumor_Type = `Tumor Type` 
  ) |>
  drop_na(
    Diagnosis_Age,
    `Overall Survival (days)`,
    Status_Tumor,
    Tumor_Type 
  ) |>
  filter(
    Tumor_Type == "Pancreas Adenocarcinoma, Ductal Type" |
    Tumor_Type == "Pancreas Adenocarcinoma, Other Subtype"
  )

## Define Age Groups (Low vs High) using the median
age_med <- median(data_age_tumor[["Diagnosis_Age"]], na.rm = TRUE)

data_age_tumor <- data_age_tumor |>
  mutate(
    Age_Group = case_when(
      Diagnosis_Age > age_med ~ "High Age",
      Diagnosis_Age <= age_med ~ "Low Age"
    ),
    Combined_Group = str_c(Age_Group, Tumor_Type, sep = " / ")
  )

# Survival Calculation (Kaplan-Meier) 
## Calculation of Kaplan-Meier
Kaplan_meier_calc_tumor <- data_age_tumor |>
  select(
    time = `Overall Survival (days)`,
    status = Status_Tumor,
    group = Combined_Group 
  ) |>
  arrange(group, time) |>
  group_by(group, time, status) |>
  tally() |>
  pivot_wider(
    names_from = status,
    values_from = n,
    values_fill = 0
  ) |>
  rename(events = `1`, censored = `0`) |> 
  group_by(group) |>
  mutate(
    # n_risk-> Calculate number at risk by summing all future events + censored
    n_risk = rev(cumsum(rev(events + censored))),
    # surv_step-> Calculate probability of survival at this time point
    surv_step = 1 - events / n_risk,
    # surv > Cumulative of surv_step gives the KM estimate
    surv = cumprod(surv_step)
  ) |>
  ungroup()

# Plot KM Curve 
ggplot(Kaplan_meier_calc_tumor, aes(x = time,
                                    y = surv,
                                    color = group)) + 
  geom_step(linewidth = 1.1) +
  scale_color_manual(
    # Define colors for all four groups
    values = c(
      "High Age / Pancreas Adenocarcinoma, Ductal Type" = "#E74C3C", 
      "Low Age / Pancreas Adenocarcinoma, Ductal Type"  = "#3498DB", 
      "High Age / Pancreas Adenocarcinoma, Other Subtype" = "#2ECC71", 
      "Low Age / Pancreas Adenocarcinoma, Other Subtype"  = "#F1C40F"  
    ) 
  ) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(
    title = "Survival of Patients\nStratified by Diagnosis Age and Tumor Type",
    x = "Overall Survival Time (days)",
    y = "Survival Probability",
    color = "Age and Tumor Type Group"
  )
```

#### Kaplan-Meier survival analysis based on **Diagnosis Age/ Tumor Stage**

```{r}

# Define Data
data_age_stage <- data_code |>
  full_join(data_metrics, by = "Patient ID") |>
  full_join(data_diag, by = "Patient ID") |>
  rename(`Cancer Stage` = `Neoplasm Disease Stage American Joint Committee on Cancer Code`) |>
  select(
    PatientID = `Patient ID`,
    Diagnosis_Age = `Diagnosis Age`, 
    `Overall Survival (days)`,
    Status_Tumor = `Disease-specific Survival status (bin)`,
    Cancer_Stage = `Cancer Stage`
  ) |>
  drop_na(
    Diagnosis_Age,
    `Overall Survival (days)`,
    Status_Tumor,
    Cancer_Stage
  ) |>
  filter(Cancer_Stage == `STAGE IB`|
         Cancer_Stage == `STAGE IIA`|
         Cancer_Stage == `STAGE IIB`)

## Define Age Groups (Low vs High) using the median
age_med <- median(data_age_tumor[["Diagnosis_Age"]], na.rm = TRUE)

data_age_stage <- data_age_stage |>
  mutate(
    Age_Group = case_when(
      Diagnosis_Age > age_med ~ "High Age",
      Diagnosis_Age <= age_med ~ "Low Age"
    ),
    Combined_Group = str_c(Age_Group, Cancer_Stage, sep = " / ")
  )

# Survival Calculation (Kaplan-Meier) 
## Calculation of Kaplan-Meier
Kaplan_meier_calc <- data_age_stage |>
  select(
    time = `Overall Survival (days)`,
    status = Status_Tumor,
    group = Combined_Group 
  ) |>
  arrange(group, time) |>
  group_by(group, time, status) |>
  tally() |>
  pivot_wider(
    names_from = status,
    values_from = n,
    values_fill = 0
  ) |>
  rename(events = `1`, censored = `0`) |> 
  group_by(group) |>
  mutate(
    # n_risk-> Calculate number at risk by summing all future events + censored
    n_risk = rev(cumsum(rev(events + censored))),
    # surv_step-> Calculate probability of survival at this time point
    surv_step = 1 - events / n_risk,
    # surv > Cumulative of surv_step gives the KM estimate
    surv = cumprod(surv_step)
  ) |>
  ungroup()

# Plot KM Curve 
ggplot(Kaplan_meier_calc, aes(x = time,
                              y = surv,
                              color = group)) + 
  geom_step(linewidth = 1.1) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")) +
  labs(
    title = "Survival of Patients\nStratified by Diagnosis Age and Tumor Type",
    x = "Overall Survival Time (days)",
    y = "Survival Probability",
    color = "Age and Tumor Type Group"
  )
```
